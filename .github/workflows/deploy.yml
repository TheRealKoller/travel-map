name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manuelles Deployment erlauben

permissions:
  contents: read

jobs:
  # Zuerst Tests ausfÃ¼hren
  tests:
    uses: ./.github/workflows/tests.yml

  # Deployment (nur wenn Tests erfolgreich)
  deploy:
    name: Deploy to all-inkl.com
    runs-on: ubuntu-latest
    needs: tests
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

      - name: Install Node dependencies
        run: npm ci

      - name: Build production assets
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy
          
          # Kopiere alle benÃ¶tigten Dateien (exclude dev files)
          rsync -a \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='.env.testing' \
            --exclude='.env.e2e' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='database/*.sqlite*' \
            --exclude='.github' \
            --exclude='.vscode' \
            --exclude='.idea' \
            --exclude='.fleet' \
            --exclude='.nova' \
            --exclude='playwright-report' \
            --exclude='test-results' \
            --exclude='README.md' \
            --exclude='DEPLOYMENT*.md' \
            --exclude='SETUP*.md' \
            --exclude='docker-compose.yml' \
            --exclude='phpunit.xml' \
            --exclude='playwright.config.ts' \
            --exclude='scripts' \
            ./ deploy/
          
          # Erstelle .gitkeep Dateien fÃ¼r storage-Verzeichnisse
          touch deploy/storage/logs/.gitkeep
          touch deploy/storage/framework/cache/.gitkeep
          touch deploy/storage/framework/sessions/.gitkeep
          touch deploy/storage/framework/views/.gitkeep
          
          # Erstelle ZIP-Archiv fÃ¼r schnelleren Upload
          cd deploy
          zip -r -q ../deployment.zip .
          cd ..
          
          # Zeige GrÃ¶ÃŸenvergleich
          UNCOMPRESSED=$(du -sh deploy | cut -f1)
          COMPRESSED=$(du -sh deployment.zip | cut -f1)
          echo "ðŸ“¦ Deployment package created:"
          echo "  - Uncompressed: $UNCOMPRESSED"
          echo "  - Compressed: $COMPRESSED"

      - name: Upload deployment package via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          ssh_private_key: ${{ secrets.SFTP_SSH_PRIVATE_KEY }}
          username: ${{ secrets.SFTP_USERNAME }}
          server: ${{ secrets.SFTP_HOST }}
          port: 22
          password: ${{ secrets.SFTP_PASSWORD }}
          local_path: './deployment.zip'
          remote_path: ${{ secrets.SFTP_REMOTE_PATH }}
          sftp_only: false
          delete_remote_files: false

      - name: Extract and setup deployment on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            cd ${{ secrets.SFTP_REMOTE_PATH }}
            
            # Backup .env falls vorhanden
            if [ -f .env ]; then
              echo "ðŸ’¾ Backing up .env file"
              cp .env .env.backup
            fi
            
            # Entpacke das Deployment
            echo "ðŸ“¦ Extracting deployment package..."
            unzip -q -o deployment.zip
            
            # Stelle .env wieder her
            if [ -f .env.backup ]; then
              echo "ðŸ”„ Restoring .env file"
              mv .env.backup .env
            fi
            
            # LÃ¶sche das ZIP-Archiv
            rm -f deployment.zip
            
            # Setze korrekte Berechtigungen
            echo "ðŸ” Setting permissions..."
            chmod -R 755 bootstrap/cache 2>/dev/null || true
            chmod -R 755 storage 2>/dev/null || true
            
            # Laravel Cache-Optimierung
            echo "âš¡ Optimizing Laravel caches..."
            php artisan optimize:clear 2>/dev/null || true
            php artisan config:cache 2>/dev/null || true
            php artisan route:cache 2>/dev/null || true
            php artisan view:cache 2>/dev/null || true
            
            # Optional: Migrationen (auskommentiert zur Sicherheit)
            # php artisan migrate --force
            
            echo "âœ… Deployment completed successfully!"

      - name: Create deployment summary
        if: success()
        run: |
          echo "### âœ… Deployment erfolgreich!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "**Zeit:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Die Anwendung wurde erfolgreich zu all-inkl.com deployed." >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "### âŒ Deployment fehlgeschlagen!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Bitte prÃ¼fe die Logs fÃ¼r weitere Details." >> $GITHUB_STEP_SUMMARY
